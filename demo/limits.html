<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <meta charset="utf-8" />
    <style>
        body {
            font-family: system-ui;
        }

        nav {
            display: flex;
        }

        pre {
            max-width: 100vw;
            overflow: auto;
        }
    </style>
</head>

<body>
    <h1>Get providers structures by query_limit demo</h1>
    <nav>
        <form onsubmit="getProvider(selectProvider.value, inputFilter.value, selectPage.value || 0)">
            <fieldset>
                <legend>Select provider</legend>
                <input id="filter" placeholder="type formula" />
                <select id="providers" onchange="selecting()"></select>
                <select id="pages"></select>
                <button>get provider</button>
            </fieldset>
        </form>
        <fieldset>
            <legend>Select all providers</legend>
            <button
                onclick="getAllProviders(Object.keys(optimadeClient.providers), inputFilter.value, selectPage.value || 0)">get
                providers</button>
        </fieldset>

    </nav>
    <h2>Result:</h2>
    <pre>
        <code>click some button</code>
    </pre>

    <script type="text/javascript" src="../dist/index.js"></script>
    <script>
        "use strict";
        const optimadeClient = new optimade.Optimade({ corsProxyUrl: 'https://cors.optimade.science' });
        const inputFilter = document.querySelector('input')
        const selectProvider = document.querySelector('#providers')
        const selectPage = document.querySelector('#pages')
        const code = document.querySelector('code')

        window.onload = fetch('../dist/prefetched.json').then(response => response.json()).then(prefetched => {
            optimadeClient.providers = prefetched.providers;
            optimadeClient.apis = prefetched.apis;

            const providersOptions = Object.keys(optimadeClient.providers).map(p => {
                const option = document.createElement('option')
                option.value = p
                option.innerText = p
                return option
            })
            selectProvider.append(...providersOptions)
        })

        function selecting() {
            console.log(selectProvider.value)
            selectPage.innerHTML = ''
        }
        inputFilter.value = 'chemical_formula_anonymous="A2B"'
        inputFilter.size = inputFilter.value.length - 5;


        let current = 0
        function getProvider(provider, filter, page) {
            event.preventDefault()
            code.innerText = '...loading'
            optimadeClient.getProviderStructures(provider, filter, page).then(results => {
                console.dir(results);
                const [result] = results

                function setSelectPage(result) {
                    const calcPages = () => {
                        const pages = result.meta.pages
                        return pages === 1 || pages === 0 || pages === Infinity ? 0 : pages
                    }
                    const pages = calcPages()
                    console.log(pages)

                    if (pages > 0 && current !== pages) {
                        const pagesOptions = [...Array(pages).keys()].map(p => {
                            const option = document.createElement('option')
                            option.value = p
                            option.innerText = p
                            return option
                        })
                        selectPage.replaceChildren(...pagesOptions)
                        current = calcPages()
                    }
                }

                if (result instanceof Error) {
                    code.innerText = result
                } else {
                    setSelectPage(result)
                    const { data, meta } = result
                    const structures = { data: data.length, meta }
                    code.innerText = JSON.stringify(structures, 0, 2)
                }
            }).catch(err => console.log(err))
        }

        function getAllProviders(providers, filter, page) {
            code.innerText = '...loading'
            optimadeClient.getAllProvidersStructures(providers, filter, page).then(results => {
                console.dir(results);
                const structures = results && results.map(result => {
                    if (result[0].some(r => r instanceof Error)) {
                        const [[error], provider] = result
                        const response = { error, provider }
                        return response
                    } else {
                        const [[{ data, meta }], provider] = result
                        const response = {
                            apis: [{ data: data.length, meta }],
                            provider
                        }
                        return response
                    }
                })
                code.innerText = JSON.stringify(structures, 0, 2)
            });
        }

    </script>
</body>

</html>